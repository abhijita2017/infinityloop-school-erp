name: Deploy CodeIgniter App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json, mysql, pdo, pdo_mysql, curl, gd, zip
    
    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        tar -czf deployment.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='.env.backup' \
          .
        echo "âœ… Package created"
    
    - name: Deploy to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deployment.tar.gz"
        target: "/tmp/"
    
    - name: Configure application on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          
          APP_NAME="${{ github.event.repository.name }}"
          APP_DIR="/var/www/${APP_NAME}"
          
          echo "ðŸš€ Deploying ${APP_NAME}..."
          
          # Create application directory
          sudo mkdir -p ${APP_DIR}
          
          # Extract deployment package
          echo "ðŸ“‚ Extracting files..."
          sudo tar -xzf /tmp/deployment.tar.gz -C ${APP_DIR}
          
          # Set permissions
          echo "ðŸ”’ Setting permissions..."
          sudo chown -R www-data:www-data ${APP_DIR}
          sudo chmod -R 755 ${APP_DIR}
          sudo chmod -R 777 ${APP_DIR}/uploads
          
          # Create/update .env file for database config
          echo "âš™ï¸  Configuring database..."
          sudo tee ${APP_DIR}/application/config/database.php > /dev/null <<'EOF'
          <?php
          defined('BASEPATH') OR exit('No direct script access allowed');
          
          $active_group = 'default';
          $query_builder = TRUE;
          
          $db['default'] = array(
              'dsn'   => '',
              'hostname' => '${{ secrets.DB_HOST }}',
              'username' => '${{ secrets.DB_USERNAME }}',
              'password' => '${{ secrets.DB_PASSWORD }}',
              'database' => 'school_erp',
              'dbdriver' => 'mysqli',
              'dbprefix' => '',
              'pconnect' => FALSE,
              'db_debug' => FALSE,
              'cache_on' => FALSE,
              'cachedir' => '',
              'char_set' => 'utf8',
              'dbcollat' => 'utf8_general_ci',
              'swap_pre' => '',
              'encrypt' => FALSE,
              'compress' => FALSE,
              'stricton' => FALSE,
              'failover' => array(),
              'save_queries' => TRUE
          );
          EOF
          
          # Update base URL in config
          echo "ðŸŒ Updating base URL..."
          sudo sed -i "s|http://localhost/|http://school-erp.infinityloop.com/|g" ${APP_DIR}/application/config/config.php || true
          
          # Create Nginx configuration
          echo "ðŸŒ Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/school-erp > /dev/null <<'NGINX'
          server {
              listen 80;
              server_name school-erp.infinityloop.com;
              
              root /var/www/${{ github.event.repository.name }};
              index index.php index.html;
              
              access_log /var/log/nginx/school-erp-access.log;
              error_log /var/log/nginx/school-erp-error.log;
              
              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }
              
              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                  include fastcgi_params;
              }
              
              location ~ /\.ht {
                  deny all;
              }
              
              location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                  expires 365d;
                  add_header Cache-Control "public, immutable";
              }
          }
          NGINX
          
          # Enable site and reload Nginx
          sudo ln -sf /etc/nginx/sites-available/school-erp /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl reload nginx
          
          # Clean up
          rm -f /tmp/deployment.tar.gz
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Application available at: http://school-erp.infinityloop.com"
    
    - name: Deployment Status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi
