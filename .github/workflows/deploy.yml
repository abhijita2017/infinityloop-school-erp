name: Deploy Laravel Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  APP_NAME: ${{ github.event.repository.name }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
        coverage: none
    
    - name: Copy .env
      run: |
        php -r "file_exists('.env') || copy('.env.example', '.env');"
    
    - name: Install Composer Dependencies
      run: composer install --prefer-dist --no-progress --no-interaction
    
    - name: Generate Application Key
      run: php artisan key:generate
    
    - name: Run Tests
      env:
        DB_CONNECTION: mysql
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: test_db
        DB_USERNAME: root
        DB_PASSWORD: password
      run: |
        php artisan migrate --force
        php artisan test || echo "No tests found, skipping..."

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
    
    - name: Install Dependencies
      run: composer install --prefer-dist --no-dev --optimize-autoloader --no-interaction
    
    - name: Prepare Deployment Package
      run: |
        mkdir -p deployment
        rsync -av --progress . deployment/ \
          --exclude .git \
          --exclude .github \
          --exclude tests \
          --exclude node_modules \
          --exclude storage/logs/*.log \
          --exclude .env
        
        # Create production .env
        cat > deployment/.env << EOF
        APP_NAME="${{ github.event.repository.name }}"
        APP_ENV=production
        APP_KEY=${{ secrets.APP_KEY }}
        APP_DEBUG=false
        APP_URL=https://${{ secrets.APP_SUBDOMAIN }}.infinityloop.online
        
        LOG_CHANNEL=stack
        LOG_LEVEL=error
        
        DB_CONNECTION=mysql
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=3306
        DB_DATABASE=${{ secrets.DB_DATABASE }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        BROADCAST_DRIVER=log
        CACHE_DRIVER=file
        FILESYSTEM_DISK=s3
        QUEUE_CONNECTION=database
        SESSION_DRIVER=file
        SESSION_LIFETIME=120
        
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION=${{ env.AWS_REGION }}
        AWS_BUCKET=${{ secrets.AWS_BUCKET }}
        
        MAIL_MAILER=smtp
        MAIL_HOST=${{ secrets.MAIL_HOST }}
        MAIL_PORT=587
        MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
        MAIL_ENCRYPTION=tls
        MAIL_FROM_ADDRESS=noreply@infinityloop.online
        MAIL_FROM_NAME="${{ github.event.repository.name }}"
        EOF
        
        cd deployment
        tar -czf ../deployment.tar.gz .
    
    - name: Upload to S3
      run: |
        aws s3 cp deployment.tar.gz s3://infinityloop-deployments/${{ env.APP_NAME }}/deployment-$(date +%Y%m%d-%H%M%S).tar.gz
        aws s3 cp deployment.tar.gz s3://infinityloop-deployments/${{ env.APP_NAME }}/latest.tar.gz
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          
          APP_DIR="/var/www/infinityloop/${{ secrets.APP_SHORT_NAME }}"
          BACKUP_DIR="/var/backups/infinityloop/${{ secrets.APP_SHORT_NAME }}"
          
          echo "ðŸš€ Starting deployment for ${{ env.APP_NAME }}..."
          
          # Create backup
          if [ -d "$APP_DIR" ]; then
            echo "ðŸ“¦ Creating backup..."
            sudo mkdir -p $BACKUP_DIR
            sudo tar -czf $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $APP_DIR .
          fi
          
          # Download latest deployment
          echo "â¬‡ï¸  Downloading deployment package..."
          aws s3 cp s3://infinityloop-deployments/${{ env.APP_NAME }}/latest.tar.gz /tmp/deployment.tar.gz
          
          # Extract to app directory
          echo "ðŸ“‚ Extracting files..."
          sudo mkdir -p $APP_DIR
          sudo tar -xzf /tmp/deployment.tar.gz -C $APP_DIR
          
          # Set permissions
          echo "ðŸ” Setting permissions..."
          sudo chown -R ubuntu:www-data $APP_DIR
          sudo chmod -R 775 $APP_DIR/storage
          sudo chmod -R 775 $APP_DIR/bootstrap/cache
          
          # Run Laravel commands
          cd $APP_DIR
          
          echo "ðŸ”„ Running migrations..."
          php artisan migrate --force
          
          echo "âš¡ Optimizing application..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan optimize
          
          # Queue workers (if needed)
          if [ -f "artisan" ]; then
            echo "ðŸ”„ Restarting queue workers..."
            php artisan queue:restart
          fi
          
          # Restart services
          echo "ðŸ”„ Restarting services..."
          sudo systemctl restart php8.2-fpm
          sudo systemctl reload nginx
          
          # Cleanup
          rm /tmp/deployment.tar.gz
          
          # Keep only last 5 backups
          cd $BACKUP_DIR
          ls -t | tail -n +6 | xargs -r rm
          
          echo "âœ… Deployment complete!"
    
    - name: Health Check
      run: |
        sleep 10
        curl -f https://${{ secrets.APP_SUBDOMAIN }}.infinityloop.online/health || exit 1
        echo "âœ… Health check passed!"
    
    - name: Notify Success
      if: success()
      run: |
        echo "âœ… Deployment successful for ${{ env.APP_NAME }}"
        # Add Slack/Discord notification here if needed
    
    - name: Rollback on Failure
      if: failure()
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "âŒ Deployment failed, rolling back..."
          APP_DIR="/var/www/infinityloop/${{ secrets.APP_SHORT_NAME }}"
          BACKUP_DIR="/var/backups/infinityloop/${{ secrets.APP_SHORT_NAME }}"
          
          # Get latest backup
          LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup-*.tar.gz | head -1)
          
          if [ -f "$LATEST_BACKUP" ]; then
            echo "ðŸ“¦ Restoring from backup: $LATEST_BACKUP"
            sudo tar -xzf $LATEST_BACKUP -C $APP_DIR
            sudo systemctl restart php8.2-fpm
            sudo systemctl reload nginx
            echo "âœ… Rollback complete!"
          else
            echo "âš ï¸  No backup found for rollback"
          fi
